name: CI

on:
    pull_request:
        paths-ignore:
            - "**/**/*.md"
            - "docs/**"
            - ".vscode/**"
            - ".github/**"
        branches: [main, master]

jobs:
    backend-tests:
        name: Backend Tests
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Run backend tests
              env:
                  DOCKER_COMPOSE: docker compose
              run: make test-backend

            - name: Clean up
              if: always()
              env:
                  DOCKER_COMPOSE: docker compose
              run: make test-clean

            - name: Upload backend coverage
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: backend-coverage
                  path: artifacts/coverage/backend/
                  retention-days: 7

            - name: Upload backend coverage to Coveralls
              uses: coverallsapp/github-action@v2
              if: success()
              with:
                  github-token: ${{ secrets.GITHUB_TOKEN }}
                  path-to-lcov: artifacts/coverage/backend/coverage.out
                  flag-name: backend
                  parallel: true
                  format: golang

    frontend-tests:
        name: Frontend Tests
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Run frontend tests
              env:
                  DOCKER_COMPOSE: docker compose
              run: make test-frontend

            - name: Clean up
              if: always()
              env:
                  DOCKER_COMPOSE: docker compose
              run: make test-clean

            - name: Upload frontend coverage
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: frontend-coverage
                  path: artifacts/coverage/frontend/
                  retention-days: 7

            - name: Upload frontend coverage to Coveralls
              uses: coverallsapp/github-action@v2
              if: success()
              with:
                  github-token: ${{ secrets.GITHUB_TOKEN }}
                  path-to-lcov: artifacts/coverage/frontend/lcov.info
                  flag-name: frontend
                  parallel: true
                  base-path: frontend

    production-builds:
        name: Production Builds
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Build production images
              run: make build-production

            - name: Verify images exist
              run: |
                  docker images | grep industry-tool-backend
                  docker images | grep industry-tool-frontend
                  echo "âœ… Production images verified"

    e2e-tests:
        name: E2E Tests
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Build backend image
              uses: docker/build-push-action@v6
              with:
                  context: .
                  file: Dockerfile
                  target: final-backend
                  load: true
                  tags: industry-tool-backend:latest
                  cache-from: type=gha,scope=e2e-backend
                  cache-to: type=gha,mode=max,scope=e2e-backend

            - name: Build mock-esi image
              uses: docker/build-push-action@v6
              with:
                  context: .
                  file: Dockerfile.mock-esi
                  load: true
                  tags: industry-tool-mock-esi:latest
                  cache-from: type=gha,scope=e2e-mock-esi
                  cache-to: type=gha,mode=max,scope=e2e-mock-esi

            - name: Build frontend image
              uses: docker/build-push-action@v6
              with:
                  context: .
                  file: Dockerfile.ui
                  load: true
                  tags: industry-tool-frontend:latest
                  cache-from: type=gha,scope=e2e-frontend

            - name: Run E2E tests
              env:
                  DOCKER_COMPOSE: docker compose
                  E2E_BUILD_FLAG: "--no-build"
              run: make test-e2e-ci

            - name: Upload Playwright report
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: playwright-report
                  path: artifacts/e2e-report/
                  retention-days: 7

            - name: Upload test screenshots
              uses: actions/upload-artifact@v4
              if: failure()
              with:
                  name: e2e-screenshots
                  path: e2e/test-results/
                  retention-days: 7

            - name: Clean up
              if: always()
              env:
                  DOCKER_COMPOSE: docker compose
              run: make test-e2e-clean

    coveralls-finish:
        name: Finalize Coveralls
        runs-on: ubuntu-latest
        needs: [backend-tests, frontend-tests]
        if: always()

        steps:
            - name: Finalize Coveralls parallel build
              uses: coverallsapp/github-action@v2
              with:
                  github-token: ${{ secrets.GITHUB_TOKEN }}
                  parallel-finished: true

    test-summary:
        name: Test Summary
        runs-on: ubuntu-latest
        needs: [backend-tests, frontend-tests, production-builds, e2e-tests]
        if: always()

        steps:
            - name: Check test results
              env:
                  BACKEND_RESULT: ${{ needs.backend-tests.result }}
                  FRONTEND_RESULT: ${{ needs.frontend-tests.result }}
                  PRODUCTION_RESULT: ${{ needs.production-builds.result }}
                  E2E_RESULT: ${{ needs.e2e-tests.result }}
              run: |
                  if [ "$BACKEND_RESULT" != "success" ] || [ "$FRONTEND_RESULT" != "success" ] || [ "$PRODUCTION_RESULT" != "success" ] || [ "$E2E_RESULT" != "success" ]; then
                    echo "CI checks failed!"
                    echo "Backend Tests: $BACKEND_RESULT"
                    echo "Frontend Tests: $FRONTEND_RESULT"
                    echo "Production Builds: $PRODUCTION_RESULT"
                    echo "E2E Tests: $E2E_RESULT"
                    exit 1
                  else
                    echo "All CI checks passed!"
                  fi
